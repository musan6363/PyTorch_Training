Bootstrap: docker
From: nvidia/cuda:11.3.1-cudnn8-devel-ubuntu20.04

%environment
	export TZ=Asia/Tokyo
	export CUDA_PATH=/usr/local/cuda
	export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

	export PYENV_ROOT="/opt/pyenv"
	export PATH="$PYENV_ROOT/bin:$PATH"

	export POETRY_HOME=/opt/poetry
    export PATH=$POETRY_HOME/bin:$PATH

    export PYTHON_VERSION=3.11

%post
    perl -p -i.bak -e 's%(deb(?:-src|)\s+)https?://(?!archive\.canonical\.com|security\.ubuntu\.com)[^\s]+%$1http://ftp.riken.jp/Linux/ubuntu/%' /etc/apt/sources.list

	export DEBIAN_FRONTEND=noninteractive
	export TZ=Asia/Tokyo

	export PYENV_ROOT="/opt/pyenv"
	export PATH="$PYENV_ROOT/bin:$PATH"
	export PYTHON_VERSION=3.11
	export POETRY_ROOT="/opt/poetry"

	apt-get -y update
	apt-get -y dist-upgrade
    apt-get -y install \
		build-essential \
        curl \
        git \
        libbz2-dev \
        libffi-dev \
        libreadline-dev \
        libsqlite3-dev \
        libssl-dev \
        liblzma-dev \
        llvm \
        make \
        tk-dev \
        wget \
        xz-utils \
        zlib1g-dev

	# Install pyenv
    git clone https://github.com/pyenv/pyenv.git $PYENV_ROOT

	
	eval "$(pyenv init --path)"

	pyenv install $PYTHON_VERSION
	pyenv local $PYTHON_VERSION

	# Install poetry
	curl -sSL https://install.python-poetry.org | POETRY_HOME=$POETRY_ROOT python -

%labels
    Author Hiroto Murakami
    Version v1.0.0
